<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>ğŸ”¥ Red Chat</title>

<style>
body{
  margin:0;
  font-family:Arial;
  background:#111;
  color:white;
  display:flex;
  justify-content:center;
}
.container{
  width:400px;
  margin-top:20px;
}
.card{
  background:#1b1b1b;
  padding:20px;
  border-radius:15px;
  box-shadow:0 0 15px rgba(255,0,0,0.4);
}
input,button{
  width:100%;
  padding:10px;
  margin:6px 0;
  border:none;
  border-radius:8px;
}
input{ background:#2b2b2b; color:white; }
button{
  background:red;
  color:white;
  font-weight:bold;
  cursor:pointer;
}
.chat{
  height:300px;
  overflow-y:auto;
  background:#000;
  padding:10px;
  border-radius:10px;
}
.msg{
  background:#222;
  margin:5px 0;
  padding:8px;
  border-radius:8px;
}
.private{ background:#440000; }
.profile-img{
  width:60px;
  height:60px;
  border-radius:50%;
  object-fit:cover;
}
</style>
</head>
<body>

<div class="container">

<!-- LOGIN -->
<div class="card" id="authBox">
<h2>ğŸ”¥ Red Chat</h2>
<input id="username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
<input id="password" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
<input id="avatar" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©">
<button onclick="register()">ØªØ³Ø¬ÙŠÙ„</button>
<button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
</div>

<!-- CHAT -->
<div class="card" id="chatBox" style="display:none;">
<div style="display:flex;align-items:center;gap:10px;">
<img id="profileImg" class="profile-img">
<h3 id="profileName"></h3>
</div>

<div class="chat" id="messages"></div>

<input id="msgInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...">
<button onclick="sendMessage()">Ø¥Ø±Ø³Ø§Ù„</button>

<hr>
<h4>ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…</h4>
<input id="searchUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
<button onclick="search()">Ø¨Ø­Ø«</button>
<div id="searchResult"></div>

</div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
// ğŸ”´ Ø¶Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Firebase Ù‡Ù†Ø§
const firebaseConfig = {
  apiKey: "PUT_KEY",
  authDomain: "PUT_DOMAIN",
  projectId: "PUT_PROJECT_ID"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let currentUser=null;
let lastSend=0;

// ØªØ³Ø¬ÙŠÙ„
async function register(){
  const user=username.value.trim();
  const pass=password.value.trim();
  const avatarUrl=avatar.value.trim();

  if(pass.length<8 || !/\d/.test(pass)){
    alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 8 Ø£Ø­Ø±Ù ÙˆØªØ­ØªÙˆÙŠ Ø±Ù‚Ù…");
    return;
  }

  await db.collection("users").doc(user).set({
    password:pass,
    avatar:avatarUrl,
    friends:[],
    requests:[]
  });

  alert("ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„!");
}

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
async function login(){
  const user=username.value.trim();
  const pass=password.value.trim();

  const doc=await db.collection("users").doc(user).get();
  if(!doc.exists || doc.data().password!==pass){
    alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©");
    return;
  }

  currentUser=user;
  authBox.style.display="none";
  chatBox.style.display="block";
  profileName.innerText=user;
  profileImg.src=doc.data().avatar || "https://i.imgur.com/4Z7pK.jpg";

  loadMessages();
}

// Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
async function sendMessage(){
  const now=Date.now();
  if(now-lastSend<5000){
    alert("Ø§Ù†ØªØ¸Ø± 5 Ø«ÙˆØ§Ù†ÙŠ");
    return;
  }

  const text=msgInput.value.trim();
  if(!text) return;

  await db.collection("messages").add({
    user:currentUser,
    text:text,
    time:now
  });

  msgInput.value="";
  lastSend=now;
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
function loadMessages(){
  db.collection("messages")
    .orderBy("time")
    .onSnapshot(snapshot=>{
      messages.innerHTML="";
      snapshot.forEach(doc=>{
        const m=doc.data();
        messages.innerHTML+=`
        <div class="msg">
          <b>${m.user}</b>: ${m.text}
          ${m.user!==currentUser ? `<button onclick="privateChat('${m.user}')">ğŸ’¬</button>`:""}
        </div>`;
      });
      messages.scrollTop=messages.scrollHeight;
    });
}

// Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…
async function search(){
  const name=searchUser.value.trim();
  const doc=await db.collection("users").doc(name).get();

  if(!doc.exists){
    searchResult.innerText="âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯";
    return;
  }

  searchResult.innerHTML=`
    âœ”ï¸ ${name}
    <button onclick="sendFriend('${name}')">Ø¥Ø¶Ø§ÙØ© ØµØ¯ÙŠÙ‚</button>
  `;
}

// Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ ØµØ¯Ø§Ù‚Ø©
async function sendFriend(name){
  await db.collection("users").doc(name).update({
    requests: firebase.firestore.FieldValue.arrayUnion(currentUser)
  });
  alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨");
}

// Ø¯Ø±Ø¯Ø´Ø© Ø®Ø§ØµØ©
function privateChat(user){
  const text=prompt("Ø±Ø³Ø§Ù„Ø© Ø®Ø§ØµØ© Ø¥Ù„Ù‰ "+user);
  if(!text) return;

  db.collection("private").add({
    from:currentUser,
    to:user,
    text:text,
    time:Date.now()
  });

  alert("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„");
}
</script>
</body>
</html>
